<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/staff.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<title>Staff Dashboard</title>
</head>
<body>

<nav class="header-navbar">
  <div class="brandname">
    <div class="logo">
      <img src="/logo.png" alt="Logo" class="logo-img">
    </div>
    <h2>G'ray Countryside Cafe Est.2018</h2>
    
    <div class="Contacts"><h6>Contact Number: 0997-4600154</h6></div>
    </div>

     <div class="logout-btn">
    <a href="/logout"><button>Logout</button></a>
  </div>
</nav>

<div class="staffdashboard">
  <div class="dashboard">

    <div class="sidebar">
      <h2>Category</h2>
      <br>

      <button class="category-btn active" id="category1" data-category="all">All Products</button>
      <br>
      <button class="category-btn" id="category2" data-category="Rice">Rice Bowl Meals</button>
      <br>
      <button class="category-btn" id="category3" data-category="Sizzling">Hot Sizzlers</button>
      <br>
      <button class="category-btn" id="category4" data-category="Party">Party Tray</button>
      <br>
      <button class="category-btn" id="category5" data-category="Drink">Drinks</button>
      <br>
      <button class="category-btn" id="category6" data-category="Cafe">Coffee</button>
      <br>
      <button class="category-btn" id="category7" data-category="Milk">Milk Tea</button>
      <br>
      <button class="category-btn" id="category8" data-category="Frappe">Frappe</button>
      <br>
      <button class="category-btn" id="category9" data-category="Snack & Appetizer">Snacks & Appetizer</button>
      <br>
      <button class="category-btn" id="category10" data-category="Budget Meals Served with Rice">Budget Meals Served with Rice</button>
      <br>
      <button class="category-btn" id="category11" data-category="Specialties">Specialties</button>

      <footer>&copy; 2026 For School Purposes Only. All rights reserved.</footer>
    </div>

    <div class="center"> 
      <input type="text" class="search" placeholder="Search Menu" onkeyup="searchFood(this.value)">
      <div id="menuContainer" class="menu-grid">
      </div>
    </div>

    <!-- CART -->
<div class="product">
  <h3>Products</h3>
 
  <p>Order Type: <span id="orderTypeDisplay">None</span></p>
  <ul id="productlist"></ul>




  <div class="totals">
  <p>Subtotal: ₱<span id="subtotal">0.00</span></p>
  <p>Tax (10%): ₱<span id="tax">0.00</span></p>
  <h3>Total Cash: ₱<span id="totals">0.00</span></h3>
  </div>
  
  <div class="payment-section">
  <div class="order-type-row">
    <button class="dineinandtakeout-btn" Onclick="setDineIn()">Dine In</button>
    <button class="dineinandtakeout-btn" Onclick="setTakeout()">Take Out</button>
  </div>
   <button class="pay-btn" onclick="Payment()">Pay</button>
</div>
 
</div>
<div id="receipt" style="display: none;">
  <div style="text-align: center; margin-bottom: 15px;">
    <h2>G'RAY COUNTRYSIDE CAFE</h2>
    <p>Est. 2018</p>
    <p>Contact: (XXX) XXX-XXXX</p>
    <div class="separator"></div>
  </div>
  
  <p style="text-align: center;"><strong>ORDER RECEIPT</strong></p>
  <p id="receiptOrderType" style="text-align: center;">[Order Type]</p>
  <p id="receiptDateTime" style="text-align: center;">[Date/Time]</p>
  <div class="separator"></div>
  
  <table id="receiptTable">
    <thead>
      <tr>
        <th style="display: none;">Item</th>
        <th style="display: none;">Qty</th>
        <th style="display: none;">Price</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
  
  <div class="separator"></div>
  
  <div class="totals-section">
    <p>
      <span>Subtotal:</span>
      <span>₱<span id="receiptSubtotal">0.00</span></span>
    </p>
    <p>
      <span>Tax (10%):</span>
      <span>₱<span id="receiptTax">0.00</span></span>
    </p>
    <h3>
      <span>TOTAL:</span>
      <span>₱<span id="receiptTotal">0.00</span></span>
    </h3>
  </div>
  <div class="receipt-footer">
    <p><strong>Thank you for your order!</strong></p>
    <p>Please come again</p>
    <p>*** For school purposes only ***</p>
    <p>Receipt ID: <span id="receiptId">[ID]</span></p>
  </div>
</div>

<script>
let currentOrder = [];
let orderType = null;
let currentCategory = 'all';
let selectedPaymentMethod = null;

/* ===================== PRODUCT CATALOG ===================== */
const productCatalog = [
  { name: 'Korean Spicy Bulgogi (Pork)', price: 158, category: 'Rice', image: 'korean_spicy_bulgogi.png' },
  { name: 'Korean Salt and Pepper (Pork)', price: 158, category: 'Rice', image: 'korean_salt_pepper_pork.png' },
  { name: 'Crispy Pork Lechon Kawali', price: 158, category: 'Rice', image: 'lechon_kawali.png' },
  { name: 'Cream Dory Fish Fillet', price: 138, category: 'Rice', image: 'cream_dory.png' },
  { name: 'Buttered Honey Chicken', price: 128, category: 'Rice', image: 'buttered_honey_chicken.png' },
  { name: 'Buttered Spicy Chicken', price: 128, category: 'Rice', image: 'buttered_spicy_chicken.png' },
  { name: 'Chicken Adobo', price: 128, category: 'Rice', image: 'chicken_adobo.png' },
  { name: 'Pork Shanghai', price: 128, category: 'Rice', image: 'pork_shanghai.png' },

  // Hot Sizzlers
  { name: 'Sizzling Pork Sisig', price: 168, category: 'Sizzling', image: 'pork_sisig.png' },
  { name: 'Sizzling Liempo', price: 168, category: 'Sizzling', image: 'liempo.png' },
  { name: 'Sizzling Porkchop', price: 148, category: 'Sizzling', image: 'porkchop.png' },
  { name: 'Sizzling Fried Chicken', price: 148, category: 'Sizzling', image: 'fried_chicken.png' },

  // Party Tray
  { name: 'Pancit Bihon (S)', price: 300, category: 'Party', image: 'pancit_bihon_small.png' },
  { name: 'Pancit Bihon (M)', price: 500, category: 'Party', image: 'pancit_bihon_medium.png' },
  { name: 'Pancit Bihon (L)', price: 700, category: 'Party', image: 'pancit_bihon_large.png' },
  { name: 'Pancit Canton (S)', price: 300, category: 'Party', image: 'pancit_canton_small.png' },
  { name: 'Pancit Canton (M)', price: 500, category: 'Party', image: 'pancit_canton_medium.png' },
  { name: 'Pancit Canton (L)', price: 700, category: 'Party', image: 'pancit_canton_large.png' },
  { name: 'Spaghetti (S)', price: 400, category: 'Party', image: 'spaghetti_small.png' },
  { name: 'Spaghetti (M)', price: 700, category: 'Party', image: 'spaghetti_medium.png' },
  { name: 'Spaghetti (L)', price: 1000, category: 'Party', image: 'spaghetti_large.png' },

  // Drinks
  { name: 'Cucumber Lemonade (Glass)', price: 38, category: 'Drink', image: 'cucumber_lemonade.png' },
  { name: 'Cucumber Lemonade (Pitcher)', price: 108, category: 'Drink', image: 'cucumber_lemonade_pitcher.png' },
  { name: 'Blue Lemonade (Glass)', price: 38, category: 'Drink', image: 'blue_lemonade.png' },
  { name: 'Blue Lemonade (Pitcher)', price: 108, category: 'Drink', image: 'blue_lemonade_pitcher.png' },
  { name: 'Red Tea (Glass)', price: 38, category: 'Drink', image: 'red_tea.png' },
  { name: 'Soda (Mismo)', price: 28, category: 'Drink', image: 'soda_mismo.png' },
  { name: 'Soda 1.5L', price: 118, category: 'Drink', image: 'soda_1.5liter.png' },

  // Coffee
  { name: 'Cafe Americano Tall', price: 88, category: 'Cafe', image: 'cafe_americano_tall.png' },
  { name: 'Cafe Americano Grande', price: 108, category: 'Cafe', image: 'cafe_americano_grande.png' },
  { name: 'Cafe Latte Tall', price: 108, category: 'Cafe', image: 'cafe_latte_tall.png' },
  { name: 'Cafe Latte Grande', price: 128, category: 'Cafe', image: 'cafe_latte_grande.png' },
  { name: 'Caramel Macchiato Tall', price: 108, category: 'Cafe', image: 'caramel_macchiato_tall.png' },
  { name: 'Caramel Macchiato Grande', price: 128, category: 'Cafe', image: 'caramel_macchiato_grande.png' },

  // Milk Tea
  { name: 'Milk Tea Regular HC', price: 68, category: 'Milk', image: 'Milktea_regular.png' },
  { name: 'Milk Tea Regular MC', price: 88, category: 'Milk', image: 'Milktea_regular_MC.png' },
  { name: 'Matcha Green Tea HC', price: 78, category: 'Milk', image: 'Matcha_greentea_HC.png' },
  { name: 'Matcha Green Tea MC', price: 88, category: 'Milk', image: 'Matcha_greentea_MC.png' },

  // Frappe
  { name: 'Matcha Green Tea HC', price: 108, category: 'Frappe', image: 'Matcha_greentea_HC.png' },
  { name: 'Matcha Green Tea MC', price: 138, category: 'Frappe', image: 'Matcha_greentea_HC.png' },
  { name: 'Cookies & Cream HC', price: 98, category: 'Frappe', image: 'Cookies_&Cream_HC.png' },
  { name: 'Cookies & Cream MC', price: 128, category: 'Frappe', image: 'Cookies_&Cream_HC.png' },
  { name: 'Strawberry & Cream HC', price: 180, category: 'Frappe', image: 'Strawberr_Cream_frappe_HC.png'},
  { name: 'Mango cheese cake HC', price: 180, category: 'Frappe', image: 'Mango_cheesecake_HC.png'},
 
  // Snacks & Appetizer
  { name: 'Cheesy Nachos', price: 88, category: 'Snack & Appetizer', image: 'cheesy_nachos.png' },
  { name: 'Nachos Supreme', price: 108, category: 'Snack & Appetizer', image: 'nachos_supreme.png' },
  { name: 'French fries', price: 58, category: 'Snack & Appetizer', image: 'french_fries.png' },
  { name: 'Clubhouse Sandwich', price: 118, category: 'Snack & Appetizer', image: 'club_house_sandwich.png' },
  { name: 'Fish and Fries', price: 128, category: 'Snack & Appetizer', image: 'fish_fries.png' },
  { name: 'Cheesy Dynamite Lumpia', price: 88, category: 'Snack & Appetizer', image: 'Cheesy_dynamite.png' },
  { name: 'Lumpiang Shanghai', price: 88, category: 'Snack & Appetizer', image: 'lumpiang_shanghai.png' },

  // Budget Meals served with Rice
  { name: 'Fried Chicken', price: 78, category: 'Budget Meals Served with Rice', image: 'fried_chicken_Meal.png' },
  { name: 'Buttered Honey Chicken', price: 78, category: 'Budget Meals Served with Rice', image: 'buttered_honey_chicken.png' },
  { name: 'Buttered Spicy Chicken', price: 78, category: 'Budget Meals Served with Rice', image: 'buttered_spicy_chicken.png' },
  { name: 'Tinapa Rice', price: 108, category: 'Budget Meals Served with Rice', image: 'Tinapa_fried_rice.png' },
  { name: 'Tuyo Pesto', price: 108, category: 'Budget Meals Served with Rice', image: 'Tuyo_pesto.png' },
  { name: 'Fried Rice', price: 128, category: 'Budget Meals Served with Rice', image: 'fried_rice.png' },
  { name: 'Plain Rice', price: 18, category: 'Budget Meals Served with Rice', image: 'plain_rice.png' },

  // Specialties
  { name: 'Sinigang (PORK)', price: 188, category: 'Specialties', image: 'sinigang_pork.png' },
  { name: 'Sinigang (Shrimp)', price: 178, category: 'Specialties', image: 'sinigang_shrimp.png' },
  { name: 'Paknet (Pakbet w/ Bagnet)', price: 188, category: 'Specialties', image: 'paknet.png' },
  { name: 'Buttered Shrimp', price: 108, category: 'Specialties', image: 'buttered_shrimp.png' },
  { name: 'Special Bulalo (good for 2-3 Persons)', price: 128, category: 'Specialties', image: 'Special_Bulalo.png' },
  { name: 'Special Bulalo Buy 1 Take 1 (good for 6-8 Persons)', price: 18, category: 'Specialties', image: 'Special_Bulalo_buy1_take1.png' }
];

/* ===================== MENU ===================== */
function renderMenu() {
  const container = document.getElementById('menuContainer');
  if (!container) return;
  container.innerHTML = '';

  const items = currentCategory === 'all'
    ? productCatalog
    : productCatalog.filter(p => p.category === currentCategory);

  items.forEach(product => {
    const card = document.createElement('div');
    card.className = 'compact-product-card';
    card.onclick = () => addItemToOrder(product.name, product.price);

    card.innerHTML = `
      <img src="/images/${product.image}" onerror="this.src='/images/default_food.jpg'" />
      <div class="compact-product-name">${product.name}</div>
      <div class="compact-product-price">₱${product.price}</div>
    `;
    container.appendChild(card);
  });
}

/* ===================== ORDER ===================== */
function addItemToOrder(name, price) {
  const item = currentOrder.find(i => i.name === name);
  item ? item.quantity++ : currentOrder.push({ name, price, quantity: 1 });
  renderOrder();
}

function removeItemFromOrder(index) {
  currentOrder[index].quantity > 1
    ? currentOrder[index].quantity--
    : currentOrder.splice(index, 1);
  renderOrder();
}

function renderOrder() {
  const list = document.getElementById('productlist');
  const subtotalEl = document.getElementById('subtotal');
  const taxEl = document.getElementById('tax');
  const totalEl = document.getElementById('totals');

  if (!list) return;

  list.innerHTML = '';
  let subtotal = 0;

  currentOrder.forEach((item, index) => {
    const total = item.price * item.quantity;
    subtotal += total;

    list.innerHTML += `
      <li>
        <span>${item.name} x${item.quantity}</span>
        <span>₱${total.toFixed(2)}</span>
        <button onclick="removeItemFromOrder(${index})">✕</button>
      </li>`;
  });

  const tax = subtotal * 0.10;
  if (subtotalEl) subtotalEl.textContent = subtotal.toFixed(2);
  if (taxEl) taxEl.textContent = tax.toFixed(2);
  if (totalEl) totalEl.textContent = (subtotal + tax).toFixed(2);
}

/* ===================== CATEGORY FILTER ===================== */
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll('.category-btn').forEach(button => {
    button.addEventListener('click', () => {
      // Get category from data attribute
      const category = button.getAttribute('data-category');
      
      // Update current category
      currentCategory = category;
      
      // Render the menu for the selected category
      renderMenu();
      
      // Update active button highlighting
      document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
    });
  });
});

/* ===================== ORDER TYPE ===================== */
function setDineIn() {
  orderType = "Dine In";
  const display = document.getElementById("orderTypeDisplay");
  if (display) display.textContent = orderType;
}

function setTakeout() {
  orderType = "Take Out";
  const display = document.getElementById("orderTypeDisplay");
  if (display) display.textContent = orderType;
}

/* ===================== PAYMENT METHOD ===================== */
function selectPaymentMethod(method) {
  selectedPaymentMethod = method;
  
  // Update button states
  const buttons = document.querySelectorAll('.paymentmethod-btn');
  buttons.forEach(btn => btn.classList.remove('active'));
  
  // Highlight selected button
  const selectedBtn = document.getElementById(`${method}-btn`);
  if (selectedBtn) {
    selectedBtn.classList.add('active');
  }
  
  // Update display based on selected method
  updatePaymentDisplay(method);
  
  // Update payment method display text
  const displayElement = document.getElementById("paymentMethodDisplay");
  if (displayElement) {
    // Format the display text nicely
    let displayText = "";
    switch(method) {
      case 'paymaya': displayText = "PayMaya"; break;
      case 'gcash': displayText = "GCash"; break;
      default: displayText = "Not selected";
    }
    displayElement.textContent = displayText;
  }
}

function updatePaymentDisplay(method) {
  const display = document.getElementById('payment-display');
  if (!display) return;
  
  switch(method) {
    case 'paymaya':
      display.innerHTML = getPayMayaHTML();
      break;
    case 'gcash':
      display.innerHTML = getGCashHTML();
      break;
    default:
      display.innerHTML = getDefaultHTML();
  }
}

function getPayMayaHTML() {
  // Generate a random QR code identifier for demo purposes
  const qrId = Math.random().toString(36).substring(2, 15);
  const total = parseFloat(document.getElementById('totals')?.textContent || '0');
  
  // Generate QR code URL for PayMaya
  const qrData = `paymaya://payment?amount=${total}&ref=${qrId}&merchant=Restaurant`;
  const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrData)}`;
  
  return `
    <h2 style="color: #0056D6; margin-bottom: 20px;">
      <i class="fas fa-mobile-alt"></i> Pay with PayMaya
    </h2>
    
    <div class="payment-info">
      <p style="color: #4a5568; margin-bottom: 20px; background: #f7fafc; padding: 15px; border-radius: 8px;">
        <i class="fas fa-info-circle"></i> Scan the QR code below using your PayMaya app to complete payment
      </p>
    </div>
    
    <div class="qr-container">
      <div class="qr-code">
        <div class="qr-placeholder" style="padding: 20px; background: white; border: 2px solid #0056D6; border-radius: 10px; text-align: center;">
          <img src="${qrCodeUrl}" alt="PayMaya QR Code" style="width: 180px; height: 180px; margin-bottom: 10px;" />
          <div style="font-family: monospace; font-size: 12px; color: #666; margin-bottom: 10px;">
            Transaction ID: ${qrId}
          </div>
          <div style="font-weight: 600; color: #0056D6; font-size: 14px;">PAYMAYA QR CODE</div>
        </div>
      </div>
    </div>
    
    <div style="text-align: center; margin: 25px 0;">
      <div style="font-weight: 600; color: #2d3748; margin-bottom: 10px; font-size: 16px;">How to Pay:</div>
      <ol style="text-align: left; display: inline-block; color: #4a5568; padding-left: 20px;">
        <li style="margin-bottom: 8px;">Open the PayMaya app on your phone</li>
        <li style="margin-bottom: 8px;">Tap "Scan QR" from the home screen</li>
        <li style="margin-bottom: 8px;">Point your camera at this QR code</li>
        <li style="margin-bottom: 8px;">Enter the amount shown below and confirm payment</li>
      </ol>
    </div>
    
    <div class="account-number" style="background: #0056D6; color: white; padding: 15px; border-radius: 8px; text-align: center; margin: 20px 0;">
      <div style="font-weight: 600; margin-bottom: 5px;">Mobile Number:</div>
      <div style="font-size: 18px; letter-spacing: 1px;">0917 123 4567</div>
    </div>
    
    <div class="payment-amount" style="background: #f0fff4; padding: 15px; border-radius: 8px; text-align: center; margin: 20px 0; border: 1px solid #c6f6d5;">
      <div style="font-weight: 600; color: #2d3748; margin-bottom: 5px;">Amount to Pay:</div>
      <div style="font-size: 24px; font-weight: bold; color: #38a169;">₱${total.toFixed(2)}</div>
    </div>
    
    <p class="payment-instruction" style="text-align: center;">
      <i class="fas fa-clock" style="color: #ed8936;"></i> This QR code will expire in 15 minutes
    </p>
    
    <button class="paymentmethod-btn" onclick="processEwalletPayment('PayMaya')" 
            style="width: 100%; margin-top: 20px; background: #0056D6; border-color: #0056D6; color: white; padding: 15px; font-size: 16px;">
      <i class="fas fa-check-circle"></i> Confirm PayMaya Payment
    </button>
  `;
}

function getGCashHTML() {
  // Generate a random QR code identifier for demo purposes
  const qrId = Math.random().toString(36).substring(2, 15);
  const total = parseFloat(document.getElementById('totals')?.textContent || '0');
  
  // Generate QR code URL for GCash
  const qrData = `gcash://payment?amount=${total}&ref=${qrId}&merchant=Restaurant`;
  const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrData)}`;
  
  return `
    <h2 style="color: #00457D; margin-bottom: 20px;">
      <i class="fas fa-wallet"></i> Pay with GCash
    </h2>
    
    <div class="payment-info">
      <p style="color: #4a5568; margin-bottom: 20px; background: #f7fafc; padding: 15px; border-radius: 8px;">
        <i class="fas fa-info-circle"></i> Scan the QR code below using your GCash app to complete payment
      </p>
    </div>
    
    <div class="qr-container">
      <div class="qr-code">
        <div class="qr-placeholder" style="padding: 20px; background: white; border: 2px solid #00457D; border-radius: 10px; text-align: center;">
          <img src="${qrCodeUrl}" alt="GCash QR Code" style="width: 180px; height: 180px; margin-bottom: 10px;" />
          <div style="font-family: monospace; font-size: 12px; color: #666; margin-bottom: 10px;">
            Transaction ID: ${qrId}
          </div>
          <div style="font-weight: 600; color: #00457D; font-size: 14px;">GCASH QR CODE</div>
        </div>
      </div>
    </div>
    
    <div style="text-align: center; margin: 25px 0;">
      <div style="font-weight: 600; color: #2d3748; margin-bottom: 10px; font-size: 16px;">How to Pay:</div>
      <ol style="text-align: left; display: inline-block; color: #4a5568; padding-left: 20px;">
        <li style="margin-bottom: 8px;">Open the GCash app on your phone</li>
        <li style="margin-bottom: 8px;">Tap "Scan QR" from the dashboard</li>
        <li style="margin-bottom: 8px;">Point your camera at this QR code</li>
        <li style="margin-bottom: 8px;">Enter your MPIN to confirm payment</li>
      </ol>
    </div>
    
    <div class="account-number" style="background: linear-gradient(135deg, #00457D, #0066CC); color: white; padding: 15px; border-radius: 8px; text-align: center; margin: 20px 0;">
      <div style="font-weight: 600; margin-bottom: 5px;">Mobile Number:</div>
      <div style="font-size: 18px; letter-spacing: 1px;">0917 765 4321</div>
    </div>
    
    <div class="payment-amount" style="background: #f0fff4; padding: 15px; border-radius: 8px; text-align: center; margin: 20px 0; border: 1px solid #c6f6d5;">
      <div style="font-weight: 600; color: #2d3748; margin-bottom: 5px;">Amount to Pay:</div>
      <div style="font-size: 24px; font-weight: bold; color: #38a169;">₱${total.toFixed(2)}</div>
    </div>
    
    <p class="payment-instruction" style="text-align: center;">
      <i class="fas fa-check-circle" style="color: #38a169;"></i> Instant payment confirmation upon scanning
    </p>
    
    <button class="paymentmethod-btn" onclick="processEwalletPayment('GCash')" 
            style="width: 100%; margin-top: 20px; background: #00457D; border-color: #00457D; color: white; padding: 15px; font-size: 16px;">
      <i class="fas fa-check-circle"></i> Confirm GCash Payment
    </button>
  `;
}

function getDefaultHTML() {
  return `
    <div class="payment-placeholder" style="text-align: center; padding: 40px 20px;">
      <i class="fas fa-wallet" style="font-size: 48px; color: #667eea; margin-bottom: 20px;"></i>
      <h3 style="color: #4a5568; margin-bottom: 10px;">Select a Payment Method</h3>
      <p class="payment-instruction" style="color: #718096;">Click on GCash or PayMaya above to proceed with your payment</p>
    </div>
  `;
}

function processEwalletPayment(method) {
  const total = parseFloat(document.getElementById('totals')?.textContent || '0');
  
  if (total <= 0) {
    alert('Please add items to your order first');
    return;
  }
  
  alert(`Processing ${method} payment for ₱${total.toFixed(2)}...\n\nPlease scan the QR code using your ${method} app to complete the transaction.`);
}

/* ===================== PAYMENT ===================== */
function Payment() {
  if (!currentOrder.length) return alert("Add items first");
  if (!orderType) return alert("Select order type");
  if (!selectedPaymentMethod) return alert("Select payment method (GCash or PayMaya)");
  
  // Calculate totals
  const subtotal = currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  const tax = subtotal * 0.10;
  const total = subtotal + tax;
  
  // Get customer info if available
  const customerName = document.getElementById('customerName')?.value || "Guest";
  const customerPhone = document.getElementById('customerPhone')?.value || "N/A";
  
  const orderData = {
    items: currentOrder,
    subtotal: subtotal,
    tax: tax,
    total: total,
    type: orderType,
    paymentMethod: selectedPaymentMethod,
    customer: {
      name: customerName,
      phone: customerPhone
    }
  };

  console.log('Sending order data:', orderData);

  // Show loading/processing indicator
  const paymentBtn = document.querySelector('#payment-btn');
  const originalText = paymentBtn ? paymentBtn.textContent : 'Pay';
  if (paymentBtn) {
    paymentBtn.disabled = true;
    paymentBtn.textContent = 'Processing...';
  }

  fetch('/api/orders', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(orderData)
  })
  .then(res => {
    if (!res.ok) {
      return res.json().then(err => { 
        throw new Error(err.message || `HTTP ${res.status}`); 
      });
    }
    return res.json();
  })
  .then(result => {
    console.log('Payment response:', result);
    if (result.success) {
      handleSuccessfulPayment(result);
    } else {
      alert("Payment failed: " + (result.message || "Unknown error"));
    }
  })
  .catch(error => {
    console.error('Payment error:', error);
    alert("Payment failed: " + error.message);
  })
  .finally(() => {
    // Reset button state
    if (paymentBtn) {
      paymentBtn.disabled = false;
      paymentBtn.textContent = originalText;
    }
  });
}

/* ===================== SUCCESS ===================== */
async function handleSuccessfulPayment(result) {
  // Format payment method for display
  let paymentMethodDisplay = "";
  switch(selectedPaymentMethod) {
    case 'paymaya': paymentMethodDisplay = "PayMaya"; break;
    case 'gcash': paymentMethodDisplay = "GCash"; break;
    default: paymentMethodDisplay = selectedPaymentMethod || "Unknown";
  }
  
  // Show success message with payment method
  alert(`Payment successful via ${paymentMethodDisplay}! Order #${result.orderId || ''}\n\nPlease scan the QR code on your ${paymentMethodDisplay} app to complete the transaction.`);
  
  await printReceipt();
  
  // Reset everything after successful payment
  currentOrder = [];
  orderType = null;
  selectedPaymentMethod = null;
  renderOrder();
  
  // Update displays
  const orderTypeDisplay = document.getElementById("orderTypeDisplay");
  if (orderTypeDisplay) orderTypeDisplay.textContent = "None";
  
  const paymentMethodDisplayEl = document.getElementById("paymentMethodDisplay");
  if (paymentMethodDisplayEl) paymentMethodDisplayEl.textContent = "Not selected";
  
  // Clear customer info if fields exist
  const customerNameInput = document.getElementById('customerName');
  const customerPhoneInput = document.getElementById('customerPhone');
  if (customerNameInput) customerNameInput.value = '';
  if (customerPhoneInput) customerPhoneInput.value = '';
  
  // Clear active payment button
  document.querySelectorAll('.paymentmethod-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Reset payment display
  const paymentDisplay = document.getElementById('payment-display');
  if (paymentDisplay) updatePaymentDisplay(null);
  
  // Update stats display if on admin dashboard
  if (typeof updateStatsDisplay === 'function') {
    updateStatsDisplay();
  }
}

/* ===================== RECEIPT ===================== */
function printReceipt() {
  return new Promise(resolve => {
    const subtotal = currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const tax = subtotal * 0.10;
    const total = subtotal + tax;
    
    // Format payment method for receipt
    let paymentMethodDisplay = "";
    let qrCodeUrl = "";
    
    switch(selectedPaymentMethod) {
      case 'paymaya': 
        paymentMethodDisplay = "PayMaya";
        const paymayaQrId = Math.random().toString(36).substring(2, 15);
        const paymayaQrData = `paymaya://payment?amount=${total}&ref=${paymayaQrId}&merchant=Restaurant`;
        qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(paymayaQrData)}`;
        break;
      case 'gcash': 
        paymentMethodDisplay = "GCash";
        const gcashQrId = Math.random().toString(36).substring(2, 15);
        const gcashQrData = `gcash://payment?amount=${total}&ref=${gcashQrId}&merchant=Restaurant`;
        qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(gcashQrData)}`;
        break;
      default: 
        paymentMethodDisplay = selectedPaymentMethod || "Unknown";
    }
    
    const win = window.open('', '', 'width=400,height=700');
    win.document.write(`
      <html>
        <head>
          <title>Receipt</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h3 { text-align: center; color: #333; }
            .receipt-item { display: flex; justify-content: space-between; margin: 5px 0; }
            .total { font-weight: bold; border-top: 1px solid #333; padding-top: 10px; }
            .payment-method { 
              background: #f0f0f0; 
              padding: 10px; 
              border-radius: 5px; 
              margin: 10px 0;
              text-align: center;
            }
            .qr-code-container {
              text-align: center;
              margin: 20px 0;
              padding: 15px;
              border: 1px dashed #ccc;
              border-radius: 10px;
            }
            .qr-code-img {
              width: 150px;
              height: 150px;
              margin: 10px auto;
            }
          </style>
        </head>
        <body>
          <h3>PAYMENT RECEIPT</h3>
          <p><strong>Order Type:</strong> ${orderType || 'N/A'}</p>
          <div class="payment-method">
            <strong>Payment Method:</strong> ${paymentMethodDisplay}
          </div>
          
          ${qrCodeUrl ? `
          <div class="qr-code-container">
            <strong>Scan to Pay with ${paymentMethodDisplay}</strong>
            <div class="qr-code-img">
              <img src="${qrCodeUrl}" alt="${paymentMethodDisplay} QR Code" style="width: 150px; height: 150px;" />
            </div>
            <p style="font-size: 12px; color: #666;">
              Open ${paymentMethodDisplay} app → Scan QR → Enter amount
            </p>
          </div>
          ` : ''}
          
          <hr>
          ${currentOrder.map(item => `
            <div class="receipt-item">
              <span>${item.name} x${item.quantity}</span>
              <span>₱${(item.price * item.quantity).toFixed(2)}</span>
            </div>
          `).join('')}
          <hr>
          <div class="receipt-item">
            <span>Subtotal:</span>
            <span>₱${subtotal.toFixed(2)}</span>
          </div>
          <div class="receipt-item">
            <span>Tax (10%):</span>
            <span>₱${tax.toFixed(2)}</span>
          </div>
          <div class="receipt-item total">
            <span>Total:</span>
            <span>₱${total.toFixed(2)}</span>
          </div>
          <p style="text-align: center; margin-top: 20px; font-style: italic;">
            Thank you for your order!<br>
            Payment to be completed via ${paymentMethodDisplay}
          </p>
          <div style="text-align: center; margin-top: 20px; font-size: 12px; color: #888;">
            ${new Date().toLocaleString()}
          </div>
        </body>
      </html>
    `);
    win.document.close();
    win.print();
    win.close();
    resolve();
  });
}

/* ===================== INIT ===================== */
document.addEventListener("DOMContentLoaded", () => {
  renderMenu();
  renderOrder();
  // Initialize with GCash selected by default
  selectPaymentMethod('gcash');
});
</script>

</body>
</html>